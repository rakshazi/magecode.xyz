<!DOCTYPE html><html><head><title>An error occurred while saving the URL rewrite &mdash; MageCode &mdash; Taming Magento.</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta property="og:type" content="article" /><meta property="og:url" content="http://magecode.xyz//2015/12/17/url-indexer-duplicate-records-problem" /><meta property="og:title" content="An error occurred while saving the URL rewrite" /><meta property="og:description" content="Last few weeks I was fighting with problem that partially broke Magento url indexer. Basically the url indexer was working but at certain point it was" /><meta property="og:article:published_time" content="1450310400" /><meta property="og:article:author" content="Tsvetan Stoychev" /><meta property="og:article:section" content="Technology" /><meta property="og:article:tag" content="fixed" /><meta property="og:article:tag" content="database" /><meta property="og:article:tag" content="index" /><meta property="og:article:tag" content="url rewrite" /><meta property="og:image" content="http://magecode.xyz/media/logo.png" /><link rel="alternate" type="application/atom+xml" href="http://magecode.xyz/atom.xml" title="MageCode activity feed" /></head><body><div id="wrapper"><!-- Sidebar --><!-- --- use: - posts_categories --- --><div id="sidebar-wrapper"><ul class="sidebar-nav"><li class="sidebar-brand"><a href="/">MageCode</a></li><form action="http://www.google.com" id="cse-search-box" target="_blank"><div><fieldset role="search"><input type="hidden" name="cx" value="partner-pub-5549091042676165:3410918337" /><input type="hidden" name="ie" value="UTF-8" /><input type="text" class="search form-control" name="q"/><!--<input type="submit" name="sa" value="Search" />--></fieldset></div></form><li><a href="http://magecode.xyz/categories/extensions">Extensions</a></li><li><a href="http://magecode.xyz/categories/perfomance">Perfomace</a></li><li><a href="http://magecode.xyz/categories/fixed">Fixed</a></li><li><a href="http://magecode.xyz/categories/orders">Orders</a></li><li class="social-links"><a href="https://facebook.com/magecode.xyz" target="_blank" title="Facebook"><i class="fa fa-facebook-square"></i></a><a href="https://medium.com/@nikus" target="_blank" title="Medium"><i class="fa fa-medium"></i></a><a href="https://twitter.com/magecode_xyz" target="_blank" title="Twitter"><i class="fa fa-twitter-square"></i></a><a href="http://magecode.xyz/atom.xml" target="_blank" title="RSS feed"><i class="fa fa-rss-square"></i></a></li><li><a href="http://magecode.xyz/donate"><b>Donate</b></a></li><li><a href="http://magecode.xyz/ask">Ask</a></li><!-- --><ins class="adsbygoogle" style="display:inline-block;width:300px;height:600px" data-ad-client="ca-pub-5549091042676165" data-ad-slot="2814305939"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></ul></div><div id="page-content-wrapper"><div class="container-fluid"><div class="col-md-12"><div class="row"><h1><a href="#menu-toggle" class="btn btn-default btn-lg" id="menu-toggle"><span class="glyphicon glyphicon-menu-hamburger"></span></a> MageCode <small>Taming Magento.</small></h1></div><div class="row"><article><header><h2> An error occurred while saving the URL rewrite <small><a href="http://magecode.xyz/categories/fixed">#fixed</a></small></h2></header><div><p>Last few weeks I was fighting with problem that partially broke Magento url indexer. Basically the url indexer was working but at certain point it was breaking. At this point I was getting exception and not all url rewrites were written to core_url_rewrite table. Everyday the problem was getting bigger and bigger because all new products contained “catalog/product/view/id” (I call those urls – “ugly” urls) but the desired urls suppose to be human readable and end with “.html”.</p><p>This issue could be reproduced only on live environment and in order to reproduce it locally I had to copy all catalog tables (<code>catalog_*</code>) and <code>core_url_rewrite</code> table from live to local environment.</p><p>When I run Magento url indexer from command line I got:</p><pre><code>php shell/indexer.php --reindex catalog_url
An error occurred while saving the URL rewrite
</code></pre><p>In Magento exception log I had:</p><pre><code>exception 'PDOException' with message 'SQLSTATE[23000]:
Integrity constraint violation: 1062 Duplicate entry 'product/2469/361-1-1'
for key 'UNQ_CORE_URL_REWRITE_ID_PATH_IS_SYSTEM_STORE_ID''
</code></pre><!-- break --><h4 id="debugging">Debugging</h4><p>This error message wasn’t enough in order to identify what is the real problem. For me was clear that there was Integrity constraint violation. I could sense that there is data inconsistency but I didn’t know for how many records in <code>core_url_rewrite</code> I would have this problem. After couple of minutes studying how this indexer works I found good place from where I could get better error information (I had to temporary hack the core because I don’t use debugger). My idea was temporary to cover the exception and log data for all inserts that would fail for unique index <code>UNQ_CORE_URL_REWRITE_ID_PATH_IS_SYSTEM_STORE_ID</code>.</p><p>This index is Multiple-Column Index for 3 columns:</p><ul><li>core_url_rewrite.id_path</li><li>core_url_rewrite.is_system</li><li>core_url_rewrite.store_id</li></ul><p>This is example exception that:</p><blockquote><p>integrity constraint violation: 1062 Duplicate entry 'product/2469/361-1-1' for key 'UNQ_CORE_URL_REWRITE_ID_PATH_IS_SYSTEM_STORE_ID''</p></blockquote><p>This meant that we tried to insert data that was already duplicated and record in <code>core_url_rewrite</code> already existed with following data:</p><ul><li>core_url_rewrite.id_path = product/2469/361</li><li>core_url_rewrite.is_system = 1</li><li>core_url_rewrite.store_id = 1</li></ul><p>The best place for debugging was <code>Mage_Catalog_Model_Resource_Url::saveRewrite()</code></p><p>This is the original method definition in Magento CE 1.9.2.2:</p><pre><code class="php">/**
 * Save rewrite URL
 *
 * @param array $rewriteData
 * @param int|Varien_Object $rewrite
 * @return Mage_Catalog_Model_Resource_Url
 */
public function saveRewrite($rewriteData, $rewrite)
{
    $adapter = $this-&gt;_getWriteAdapter();
    try {
        $adapter-&gt;insertOnDuplicate($this-&gt;getMainTable(), $rewriteData);
    } catch (Exception $e) {
        Mage::logException($e);
        Mage::throwException(Mage::helper('catalog')-&gt;__('An error occurred while saving the URL rewrite'));
    }
    if ($rewrite &amp;&amp; $rewrite-&gt;getId()) {
        if ($rewriteData['request_path'] != $rewrite-&gt;getRequestPath()) {
            // Update existing rewrites history and avoid chain redirects
            $where = array('target_path = ?' =&gt; $rewrite-&gt;getRequestPath());
            if ($rewrite-&gt;getStoreId()) {
                $where['store_id = ?'] = (int)$rewrite-&gt;getStoreId();
            }
            $adapter-&gt;update(
                $this-&gt;getMainTable(),
                array('target_path' =&gt; $rewriteData['request_path']),
                $where
            );
        }
    }
    unset($rewriteData);
    return $this;
}
</code></pre><p>My idea was to comment the line where an exception was thrown and log which inserts would have <code>integrity constraint violation</code>.</p><p>Modified function looked like:</p><pre><code class="php">/**
 * Save rewrite URL
 *
 * @param array $rewriteData
 * @param int|Varien_Object $rewrite
 * @return Mage_Catalog_Model_Resource_Url
 */
public function saveRewrite($rewriteData, $rewrite)
{
    $adapter = $this-&gt;_getWriteAdapter();
    try {
        $adapter-&gt;insertOnDuplicate($this-&gt;getMainTable(), $rewriteData);
    } catch (Exception $e) {
        Mage::logException($e);
        Mage::log($rewriteData);
        //Mage::throwException(Mage::helper('catalog')-&gt;__('An error occurred while saving the URL rewrite'));
    }

    if ($rewrite &amp;&amp; $rewrite-&gt;getId()) {
        if ($rewriteData['request_path'] != $rewrite-&gt;getRequestPath()) {
            // Update existing rewrites history and avoid chain redirects
            $where = array('target_path = ?' =&gt; $rewrite-&gt;getRequestPath());
            if ($rewrite-&gt;getStoreId()) {
                $where['store_id = ?'] = (int)$rewrite-&gt;getStoreId();
            }
            $adapter-&gt;update(
                $this-&gt;getMainTable(),
                array('target_path' =&gt; $rewriteData['request_path']),
                $where
            );
        }
    }
    unset($rewriteData);

    return $this;
}
</code></pre><p>Final result in log file was:</p><pre><code>DEBUG (7): Array
(
    [store_id] =&gt; 1
    [category_id] =&gt; 361
    [product_id] =&gt; 1868
    [id_path] =&gt; product/1868/361
    [request_path] =&gt; huhu/muhu.html
    [target_path] =&gt; catalog/product/view/id/1868/category/361
    [is_system] =&gt; 1
)

DEBUG (7): Array
(
    [store_id] =&gt; 1
    [category_id] =&gt; 361
    [product_id] =&gt; 2469
    [id_path] =&gt; product/2469/361
    [request_path] =&gt; fifi/mifi.html
    [target_path] =&gt; catalog/product/view/id/2469/category/361
    [is_system] =&gt; 1
)
</code></pre><p>This information was enough to identify for which records I had problem. The easiest solution for me was to delete those records from <code>core_url_rewrite</code> table and reindex again.</p><p><strong>N.B.</strong></p><p>In my case I got lucky because I had problem only for 2 records. If I had problem for hundreds / thousands records I would spend more time in order to study how this exactly happened and what product data I have in this Magento setup.</p><p>Your thoughts?</p></div><div class="row"><a href="http://magecode.xyz/tags/database" class="badge">database</a>, <a href="http://magecode.xyz/tags/index" class="badge">index</a>, <a href="http://magecode.xyz/tags/url%20rewrite" class="badge">url rewrite</a></div><div class="row"> Author: <a href="http://ceckoslab.com/" rel="nofollow" target="_blank">Tsvetan Stoychev</a></div><div class="row"><a href="//twitter.com/share" class="twitter-share-button" data-url="http://magecode.xyz/2015/12/17/url-indexer-duplicate-records-problem" data-via="magecode_xyz" data-counturl="http://magecode.xyz/2015/12/17/url-indexer-duplicate-records-problem">Tweet</a><div class="g-plusone" data-size="medium"></div><div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div><div id="fb-root"></div></div><nav><ul class="pagination"><li><a href="http://magecode.xyz/2015/12/14/using-local-repositories-to-easily-install-private-magento-extensions-with-composer" aria-label="Previous: Using local repositories to easily install private Magento extensions with Composer"><span aria-hidden="true">&laquo; Using local repositories to easily install private Magento extensions with Composer</span></a></li><li><a href="http://magecode.xyz/2015/12/17/compatibility-extension-for-magento-1-and-php-7" aria-label="Next: Compatibility extension for Magento 1 and PHP 7"><span aria-hidden="true">Compatibility extension for Magento 1 and PHP 7 &raquo;</span></a></li></ul></nav></article><div id="disqus_thread"></div><script type="text/javascript">;var disqus_shortname='magecode';(function(){var e=document.createElement('script');e.type='text/javascript';e.async=!0;e.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(e)})();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div></div></div><link href="http://magecode.xyz/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" /><link rel="stylesheet" href="http://magecode.xyz/components/highlightjs/styles/github.css" /><link href="http://magecode.xyz/components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" /><link href="http://magecode.xyz/css/style.css" rel="stylesheet" type="text/css" /><script src="http://magecode.xyz/components/jquery/jquery.min.js"></script><script src="http://magecode.xyz/components/bootstrap/js/bootstrap.min.js"></script><script src="http://magecode.xyz/components/highlightjs/highlight.pack.js"></script><script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>hljs.initHighlightingOnLoad();</script><script type="text/javascript">(function(t,o,c,s,e,a,n){t['GoogleAnalyticsObject']=e;t[e]=t[e]||function(){(t[e].q=t[e].q||[]).push(arguments)},t[e].l=1*new Date();a=o.createElement(c),n=o.getElementsByTagName(c)[0];a.async=1;a.src=s;n.parentNode.insertBefore(a,n)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-66233712-1','auto');ga('send','pageview');</script><script>;$('#menu-toggle').click(function(e){e.preventDefault();$('#wrapper').toggleClass('toggled')});</script><script>(function(t,c,a){var e,n=t.getElementsByTagName(c)[0];if(t.getElementById(a)){return};e=t.createElement(c);e.id=a;e.async=!0;e.src='//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1';n.parentNode.insertBefore(e,n)}(document,'script','facebook-jssdk'));</script><script type="text/javascript">(function(){var e=document.createElement('script');e.type='text/javascript';e.async=!0;e.src='https://apis.google.com/js/plusone.js';var t=document.getElementsByTagName('script')[0];t.parentNode.insertBefore(e,t)})();</script><script type="text/javascript">(function(){var t=document.createElement('script');t.type='text/javascript';t.async=!0;t.src='//platform.twitter.com/widgets.js';document.getElementsByTagName('head')[0].appendChild(t)})();</script><script type="text/javascript">;$(document).ready(function(){$('table').addClass('table table-bordered table-hover')});</script></body></html>