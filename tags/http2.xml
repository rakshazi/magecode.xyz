<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title><![CDATA[MageCode]]></title>
    <link href="http://magecode.xyz/atom.xml" rel="self"/>
    <link href="http://magecode.xyz/"/>
    <updated>2016-01-04T12:12:56+00:00</updated>
    <id>http://magecode.xyz/</id>
    <author>
        <name><![CDATA[Nikita Cherniy]]></name>        <email><![CDATA[magecode.xyz@openaliasbox.org]]></email>    </author>
    <generator uri="http://sculpin.io/">Sculpin</generator>
            <entry>
            <title type="html"><![CDATA[Web server with Nginx, Letsencrypt SSL, and HTTP/2]]></title>
            <link href="http://magecode.xyz/2016/01/04/nginx-letsencrypt-http2"/>
            <updated>2016-01-04T00:00:00+00:00</updated>
            <id>http://magecode.xyz/2016/01/04/nginx-letsencrypt-http2</id>
            <author>
                <name> Nikita Cherniy </name>
            </author>
            <content type="html"><![CDATA[<p>HTTP/2 and Let's Encrypt free SSL certificates are ready for production now.</p>

<p>Here I want to describe you, how to use Nginx with Let's Encrypt certificate (with A+ rank on SSLLabs) and HTTP/2 on Ubuntu 14.04.xx
<!--break--></p>

<blockquote>
  <p>All actions in console must be under <strong>root</strong> user (call <em>sudo su</em> before start)</p>
</blockquote>

<h2 id="nginx">Nginx</h2>

<p>You need to add nginx deb repositories, because in ubuntu repos nginx is outdated (no HTTP/2 support):</p>

<pre><code class="bash">touch /etc/apt/sources.list.d/nginx.list
echo "deb http://nginx.org/packages/mainline/ubuntu/ trusty nginx" &gt;&gt; /etc/apt/sources.list.d/nginx.list
echo "deb-src http://nginx.org/packages/mainline/ubuntu/ trusty nginx" &gt;&gt; /etc/apt/sources.list.d/nginx.list
wget -q -O- http://nginx.org/keys/nginx_signing.key | apt-key add -
apt-get -qq update
apt-get install nginx
</code></pre>

<blockquote>
  <p>If you already have nginx installed, remove it, because new version (1.99 for now) will conflict with nginx-common package.</p>
</blockquote>

<p>Ok, you have latest stable nginx with HTTP/2 suppport, but you need to enable it.</p>

<p>Open your site config (default is <code>/etc/nginx/sites-enabled/default</code>) and replace <code>listen</code> lines with following ( <strong>before any other config</strong> ):</p>

<blockquote>
  <p>Change <strong>YOURDOMAIN</strong> in <code>servername</code>, <code>ssl_certificate</code> and <code>ssl_certificate_key</code> to your site address, eg: magecode.xyz\</p>
  
  <p>SSL will be configured later.</p>
</blockquote>

<pre><code>#upstream php-handler {
#  server unix:/var/run/php5-fpm.sock;
#}

#server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2; # This line needed only if you use IPv6
    servername YOURDOMAIN; # Change it to your domain name
    ssl_certificate /etc/letsencrypt/live/YOURDOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/YOURDOMAIN/privkey.pem;
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';
    ssl_dhparam /etc/nginx/ssl/dhparams.pem;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;

    # Add headers to serve security related headers
    add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload;";
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Robots-Tag none;

    # ...

#}
</code></pre>

<p>Here is my "base" config for any project:</p>

<pre><code>upstream php-handler {
  server unix:/var/run/php5-fpm.sock;
}

server {
  listen 80;
  server_name YOURDOMAIN;
  # enforce https
  return 301 https://$server_name$request_uri;
}

server {
  listen 443 ssl http2;
  server_name YOURDOMAIN;

  ssl_certificate /etc/letsencrypt/live/YOURDOMAIN/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/YOURDOMAIN/privkey.pem;
  ssl_stapling on;
  ssl_stapling_verify on;
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+A
ESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256
-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA2
56:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';
  ssl_dhparam /etc/nginx/ssl/dhparams.pem;
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:10m;

  # Add headers to serve security related headers
  add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload;";
  add_header X-Content-Type-Options nosniff;
  add_header X-Frame-Options "SAMEORIGIN";
  add_header X-XSS-Protection "1; mode=block";
  add_header X-Robots-Tag none;

  # Path to the root of your installation
  root /var/www/YOURDOMAIN/;
  # set max upload size
  client_max_body_size 10G;
  fastcgi_buffers 64 4K;

  # Disable gzip to avoid the removal of the ETag header
  gzip off;

  # Uncomment if your server is build with the ngx_pagespeed module
  # This module is currently not supported.
  #pagespeed off;

  index index.php;

  location = /robots.txt {
    allow all;
    log_not_found off;
    access_log off;
  }

  location ~ ^/(build|tests)/ {
    deny all;
  }

  location ~ ^/(?:\.|autotest|console) {
    deny all;
  }

  location / {
    try_files $uri $uri/ /index.php;
  }

  location ~ \.php(?:$|/) {
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_param HTTPS on;
    fastcgi_param modHeadersAvailable true; #Avoid sending the security headers twice
    fastcgi_pass php-handler;
    fastcgi_intercept_errors on;
  }

  # Adding the cache control header for js and css files
  # Make sure it is BELOW the location ~ \.php(?:$|/) { block
  location ~* \.(?:css|js)$ {
    add_header Cache-Control "public, max-age=7200";
    # Add headers to serve security related headers
    add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload;";
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Robots-Tag none;
    # Optional: Don't log access to assets
    access_log off;
  }

  # Optional: Don't log access to other assets
  location ~* \.(?:jpg|jpeg|gif|bmp|ico|png|swf)$ {
    access_log off;
  }
}

</code></pre>

<p>Add this line to the end of <code>http</code> section of <code>/etc/nginx/nginx.conf</code> (new nginx version removed this line from <code>nginx.conf</code>):</p>

<pre><code>include /etc/nginx/sites-enabled/*;
</code></pre>

<p>And create <code>/etc/nginx/ssl/dhparams.pem</code> (needed to enable Forward Secrecy):</p>

<pre><code class="bash">mkdir /etc/nginx/ssl
openssl dhparam -out /etc/pki/nginx/dhparams.pem 4096
</code></pre>

<blockquote>
  <p>Test your nginx configuration with <code>nginx -t</code> command before next steps</p>
</blockquote>

<p>Congratulation! Nginx now can handle requests via HTTP/2</p>

<h2 id="let%27s-encrypt-free-ssl-certificate">Let's Encrypt free SSL certificate</h2>

<p>You need to install special client to get Let's Encrypt SSL certificate:</p>

<pre><code class="bash">git clone https://github.com/letsencrypt/letsencrypt
cd letsencrypt
./letsencrypt-auto --server https://acme-v01.api.letsencrypt.org/directory -v --help
</code></pre>

<p>If all ok, now you can generate ssl ceritificate for your domain (you must stop any webserver on 80 and 443 port):</p>

<blockquote>
  <p>Follow the prompts and change <strong>YOURDOMAIN</strong> to your site address, eg: magecode.xyz</p>
</blockquote>

<pre><code class="bash">service nginx stop
./letsencrypt-auto certonly -a standalone -d YOURDOMAIN -d www.YOURDOMAIN --server https://acme-v01.api.letsencrypt.org/directory --agree-dev-preview -v
</code></pre>

<p>If all ok, you will have SSL certificate for your domain (www. domain will be added as alias).
All cert files placed in <code>/etc/letsencrypt/live/YOURDOMAIN/</code> dir, you can do <code>ls</code> on it to see them.</p>

<p>Now you can start your nginx server:</p>

<pre><code class="bash">service nginx start
</code></pre>

<p>Congratulation! Now your site will work on HTTP/2 protocol with Let's Encrypt SSL certificate and <strong>A+</strong> rank on SSLLabs.</p>

<blockquote>
  <p>If you not yet tested your site, go to <a href="https://www.ssllabs.com/ssltest/analyze.html">SSL Labs</a> and test it.</p>
</blockquote>

<p>I hope, this article will help to build fast and protected web.</p>

]]></content>
        </entry>
    </feed>